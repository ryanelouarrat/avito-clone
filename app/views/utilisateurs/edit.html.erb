<!-- app/views/utilisateurs/edit.html.erb -->
<div class="container mt-5 pt-5">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow">
        <div class="card-header bg-primary text-white text-center py-3">
          <h3>Modifier mon profil</h3>
        </div>
        <div class="card-body p-4">
          <% if @utilisateur.errors.any? %>
            <div class="alert alert-danger">
              <h4><%= pluralize(@utilisateur.errors.count, "erreur") %> ont empêché la modification de votre profil :</h4>
              <ul>
                <% @utilisateur.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
            </div>
          <% end %>
          
          <%= form_with(model: @utilisateur, local: true, html: { multipart: true }) do |f| %>
            <!-- Profile Picture -->
            <div class="text-center mb-4">
              <div class="profile-picture-container">
                <% if @utilisateur.profile_picture.attached? %>
                  <%= image_tag @utilisateur.profile_picture, class: "rounded-circle profile-preview", style: "width: 150px; height: 150px; object-fit: cover;" %>
                <% else %>
                  <div class="rounded-circle bg-light d-flex align-items-center justify-content-center mx-auto" style="width: 150px; height: 150px;">
                    <i class="bi bi-person-circle" style="font-size: 5rem; color: #6c757d;"></i>
                  </div>
                <% end %>
                
                <div class="mt-3">
                  <%= f.label :profile_picture, "Photo de profil", class: "btn btn-outline-secondary" %>
                  <%= f.file_field :profile_picture, class: "d-none", accept: "image/*", onchange: "showPreview(this)" %>
                  <div class="small text-muted mt-2">Formats acceptés: JPG, PNG, GIF (max 5MB)</div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <%= f.label :nom, "Nom complet", class: "form-label" %>
                <%= f.text_field :nom, class: "form-control", placeholder: "Votre nom complet", required: true %>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= f.label :email, "Adresse e-mail", class: "form-label" %>
                <%= f.email_field :email, class: "form-control", placeholder: "Votre adresse e-mail", required: true %>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <%= f.label :ville, "Ville", class: "form-label" %>
                <%= f.text_field :ville, class: "form-control", placeholder: "Votre ville" %>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= f.label :telephone, "Téléphone", class: "form-label" %>
                <%= f.telephone_field :telephone, class: "form-control", placeholder: "Votre numéro de téléphone" %>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <%= f.label :password, "Nouveau mot de passe", class: "form-label" %>
                <%= f.password_field :password, class: "form-control", placeholder: "Laissez vide pour garder le même" %>
                <div class="form-text">Minimum 6 caractères</div>
              </div>
              
              <div class="col-md-6 mb-3">
                <%= f.label :password_confirmation, "Confirmation du nouveau mot de passe", class: "form-label" %>
                <%= f.password_field :password_confirmation, class: "form-control", placeholder: "Confirmez votre nouveau mot de passe" %>
              </div>
            </div>
            
            <div class="d-flex gap-2 mt-4">
              <%= f.submit "Mettre à jour mon profil", class: "btn btn-primary" %>
              <%= link_to "Annuler", utilisateur_path(@utilisateur), class: "btn btn-outline-secondary" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function showPreview(input) {
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) {
      let preview = document.querySelector('.profile-preview');
      
      if (!preview) {
        // If there's no image yet, replace the icon with an image
        const iconContainer = document.querySelector('.rounded-circle.bg-light');
        if (iconContainer) {
          iconContainer.innerHTML = '';
          preview = document.createElement('img');
          preview.className = 'rounded-circle profile-preview';
          preview.style.width = '150px';
          preview.style.height = '150px';
          preview.style.objectFit = 'cover';
          iconContainer.appendChild(preview);
        }
      }
      
      if (preview) {
        preview.src = e.target.result;
      }
    }
    reader.readAsDataURL(input.files[0]);
  }
}
</script>

<style>
.profile-picture-container {
  position: relative;
  margin-bottom: 30px;
}
</style>